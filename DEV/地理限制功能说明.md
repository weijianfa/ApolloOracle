# 地理限制功能说明

## 一、功能概述

地理限制功能用于限制特定地区的用户访问Bot服务。根据PRD要求，本服务仅面向海外用户（非中国大陆），需要实现中国大陆IP自动拒绝。

## 二、实现方式

### 2.1 技术方案

由于Telegram Bot API不直接提供用户IP地址，地理限制的实现方式有以下几种：

1. **Webhook层面检测**（推荐）
   - 在Webhook服务器层面获取请求IP
   - 适用于生产环境使用Webhook模式

2. **Web界面检测**
   - 如果将来有Web界面，可以在前端或后端检测IP
   - 适用于需要Web界面的场景

3. **第三方服务检测**
   - 使用Telegram的某些特性（如Web App）获取IP
   - 需要Telegram支持

### 2.2 当前实现

已创建 `bot/services/geo_service.py` 地理限制服务框架，包含：

- ✅ IP地址到国家代码的转换逻辑框架
- ✅ 阻止列表配置（中国大陆：CN）
- ✅ 允许列表配置（欧美、东南亚、港澳台等）
- ✅ 开发/生产环境处理逻辑

### 2.3 配置要求

要启用地理限制功能，需要：

1. **安装依赖**（已在requirements.txt中）：
   ```bash
   pip install maxminddb
   ```

2. **获取MaxMind GeoIP数据库**：
   - 免费版：从 https://dev.maxmind.com/geoip/geoip2/geolite2/ 下载
   - 付费版：从MaxMind购买许可证
   - 下载 `GeoLite2-Country.mmdb` 文件

3. **配置环境变量**：
   ```bash
   # .env文件
   MAXMIND_LICENSE_KEY=your_license_key  # 如果使用付费API
   ```

4. **配置数据库文件路径**：
   - 将 `GeoLite2-Country.mmdb` 放在项目目录下
   - 或在 `geo_service.py` 中配置路径

## 三、使用方式

### 3.1 Webhook模式（生产环境）

在Webhook服务器中，可以获取请求IP并检测：

```python
from fastapi import Request
from bot.services.geo_service import geo_service

@app.post("/webhook/telegram")
async def telegram_webhook(request: Request):
    # 获取客户端IP
    client_ip = request.client.host
    
    # 检查IP是否允许
    is_allowed, reason = geo_service.is_ip_allowed(client_ip)
    
    if not is_allowed:
        return {"ok": False, "error": reason}
    
    # 继续处理请求...
```

### 3.2 开发环境

在开发环境（Polling模式）中，地理限制默认禁用，因为：
- Telegram Bot API不提供用户IP
- 开发环境通常不需要严格的地理限制

### 3.3 配置说明

**阻止的国家/地区**（`BLOCKED_COUNTRIES`）：
- `CN` - 中国大陆

**允许的国家/地区**（`ALLOWED_COUNTRIES`）：
- 欧美：US, CA, GB, IE, FR, DE, IT, ES, NL, BE, CH, AT, SE, NO, DK, FI, PL, PT, GR
- 东南亚：SG, MY, TH, PH, ID, VN, KH, LA, MM, BN
- 港澳台：HK, MO, TW
- 其他：AU, NZ, JP, KR, IN, BR, MX, AR, CL, ZA

## 四、注意事项

1. **IP检测准确性**：
   - 免费版GeoIP数据库可能不够准确
   - 付费版更准确但需要费用
   - VPN用户可能绕过限制

2. **误拦截处理**：
   - 如果无法确定国家，默认允许访问（避免误拦截）
   - 记录警告日志以便排查

3. **性能考虑**：
   - IP检测需要查询数据库，可能影响性能
   - 建议使用缓存减少查询次数

4. **合规性**：
   - 确保地理限制符合相关法规
   - 提供清晰的错误提示

## 五、后续优化

1. **实现IP缓存**：减少重复查询
2. **添加白名单**：允许特定用户绕过限制
3. **完善错误提示**：提供更友好的多语言提示
4. **监控和日志**：记录被阻止的IP和原因

---

**当前状态**：框架已创建，等待配置MaxMind数据库后即可启用。

