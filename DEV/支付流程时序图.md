# 支付流程时序图（Mermaid格式）

本文档包含完整的支付流程时序图，使用Mermaid语法绘制。

## 颜色说明（按项目结构划分）

- 🟧 **橙色** (`#FFE5B4`): 用户（实际用户）
- 🟢 **绿色** (`#B4FFB4`): **进程1: main.py（Telegram Bot主进程）** - 包括：
  - Telegram Bot处理（handlers）
  - 支付服务（payment_service）
  - 订单处理（order_processor）
  - 缘分居服务调用（bazi_service）
  - DeepSeek服务调用（ai_service）
- 🔵 **蓝色** (`#B4E5FF`): **进程2: Webhook服务器（webhooks/server.py）** - 仅负责：
  - PingPong Webhook接收（webhooks/pingpong.py）
  - 支付签名验证（payment_service）
  - 更新订单状态为 "paid"（共享数据库）
  - **不处理业务逻辑**（不调用缘分居API、DeepSeek API等）
- 🔴 **红色** (`#FFB4B4`): PingPong支付系统（外部第三方服务）
- 🟦 **浅蓝色** (`#B4E5FF`): Telegram Bot API（Telegram官方服务器）
- 🟣 **紫色** (`#FFB4E5`): 缘分居API（外部第三方服务）
- 🟪 **深紫色** (`#E5B4FF`): DeepSeek API（外部第三方服务）

**注意**: 
- main.py和Webhook服务器是两个**独立的进程**
- **Webhook服务器仅作为PingPong支付结果的消息转发通道**，不处理业务逻辑
- **所有业务逻辑（调用缘分居API、DeepSeek API等）都在main.py进程中处理**
- 两个进程通过**共享数据库**协作：Webhook服务器更新订单状态为"paid"，main.py定时检查并处理

---

## 一、完整支付流程时序图

```mermaid
sequenceDiagram
    participant User as 用户 #FFE5B4
    participant TelegramAPI as Telegram Bot API #B4E5FF
    participant MainProcess as 进程1: main.py<br/>(Telegram Bot) #B4FFB4
    participant PingPong as PingPong支付系统 #FFB4B4
    participant WebhookServer as 进程2: Webhook服务器<br/>(webhooks/server.py) #B4E5FF
    participant YuanfenjuAPI as 缘分居API #FFB4E5
    participant DeepSeekAPI as DeepSeek API #E5B4FF

    Note over User,DeepSeekAPI: 阶段1: 用户下单
    User->>TelegramAPI: 1. 选择产品并输入信息
    TelegramAPI->>MainProcess: 2. 接收消息（handlers/product.py）
    MainProcess->>MainProcess: 3. 创建订单 (pending_payment)
    MainProcess->>MainProcess: 4. create_order() (payment_service)
    MainProcess->>MainProcess: 5. create_payment_link() (payment_service)
    MainProcess->>PingPong: 6. 调用PingPong API创建支付
    PingPong-->>MainProcess: 7. 返回支付链接
    MainProcess->>TelegramAPI: 8. 发送支付链接
    TelegramAPI->>User: 9. 显示支付链接

    Note over User,DeepSeekAPI: 阶段2: 用户支付
    User->>PingPong: 10. 跳转支付页面
    User->>PingPong: 11. 完成支付

    Note over User,DeepSeekAPI: 阶段3: PingPong通知（Webhook服务器仅转发）
    PingPong->>WebhookServer: 12. POST /webhook/pingpong<br/>Body: {order_id, status: "paid", ...}<br/>Header: X-Signature
    WebhookServer->>WebhookServer: 13. process_payment_webhook() (payment_service)
    WebhookServer->>WebhookServer: 14. 验证HMAC签名
    WebhookServer->>WebhookServer: 15. 更新订单状态为 "paid"<br/>(共享数据库)
    WebhookServer-->>PingPong: 16. 返回 200 OK
    
    Note over User,DeepSeekAPI: 阶段4: main.py进程检测到已支付订单
    MainProcess->>MainProcess: 17. 定时任务检查订单状态<br/>(后台任务，每30秒检查一次)
    MainProcess->>MainProcess: 18. 发现状态为 "paid" 的订单
    MainProcess->>MainProcess: 19. 更新订单状态为 "generating"<br/>(共享数据库)
    
    Note over User,DeepSeekAPI: 阶段4.5: 通知用户支付成功
    MainProcess->>TelegramAPI: 20. notify_user_payment_success()
    TelegramAPI->>User: 21. ✅ 支付成功通知<br/>🔄 正在生成报告，请稍候...

    Note over User,DeepSeekAPI: 阶段5: 调用缘分居API（如果需要）
    alt 产品需要八字数据
        MainProcess->>MainProcess: 22. get_bazi_data() (bazi_service)
        MainProcess->>YuanfenjuAPI: 23. 调用缘分居API
        YuanfenjuAPI-->>MainProcess: 24. 返回八字数据
        MainProcess->>MainProcess: 25. 保存八字数据到订单<br/>(共享数据库)
    end

    Note over User,DeepSeekAPI: 阶段6: 生成AI报告
    MainProcess->>MainProcess: 26. generate_report() (ai_service)
    MainProcess->>MainProcess: 27. 加载提示词模板
    MainProcess->>MainProcess: 28. 构建完整提示词
    MainProcess->>DeepSeekAPI: 29. 调用DeepSeek API（带重试）
    DeepSeekAPI-->>MainProcess: 30. 返回AI生成的报告
    MainProcess->>MainProcess: 31. 格式化报告（Markdown→纯文本）
    MainProcess->>MainProcess: 32. 保存报告到订单<br/>(共享数据库)

    Note over User,DeepSeekAPI: 阶段7: 发送报告给用户
    MainProcess->>TelegramAPI: 33. _send_report_to_user()
    TelegramAPI->>User: 34. 发送报告标题
    TelegramAPI->>User: 35. 分段发送报告内容
    TelegramAPI->>User: 36. 发送完成提示

    Note over User,DeepSeekAPI: 阶段8: 完成订单
    MainProcess->>MainProcess: 37. 更新订单状态为 "completed"<br/>(共享数据库)
    MainProcess->>MainProcess: 38. 更新推广员统计（如果有）<br/>(共享数据库)
```

---

## 二、Webhook通知详细流程

```mermaid
sequenceDiagram
    participant PingPong as PingPong支付系统 #FFB4B4
    participant WebhookServer as 进程2: Webhook服务器<br/>(webhooks/server.py) #B4E5FF
    participant TelegramAPI as Telegram Bot API #B4E5FF
    participant User as 用户 #FFE5B4
    participant YuanfenjuAPI as 缘分居API #FFB4E5
    participant DeepSeekAPI as DeepSeek API #E5B4FF

    PingPong->>WebhookServer: POST /webhook/pingpong<br/>X-Signature: hmac_signature<br/>Body: {order_id, status, ...}
    
    WebhookServer->>WebhookServer: 提取payload和X-Signature<br/>(webhooks/pingpong.py)
    
    WebhookServer->>WebhookServer: process_payment_webhook()<br/>(payment_service)
    
    WebhookServer->>WebhookServer: 验证HMAC签名<br/>(使用PINGPONG_WEBHOOK_SECRET)
    
    alt 签名验证失败
        WebhookServer-->>PingPong: 返回 401 Unauthorized
    else 签名验证成功
        WebhookServer->>WebhookServer: 查询订单 (order_id)<br/>(共享数据库)
        
        alt 订单状态为 "paid"
            WebhookServer->>WebhookServer: 更新订单状态为 "paid"<br/>保存 payment_id<br/>(共享数据库)
            
            WebhookServer-->>PingPong: 返回 200 OK
            
            Note over MainProcess: main.py定时任务检测到已支付订单
            
            MainProcess->>MainProcess: 定时任务检查订单状态<br/>(后台任务，每30秒)
            MainProcess->>MainProcess: 发现状态为 "paid" 的订单
            MainProcess->>MainProcess: 更新订单状态为 "generating"<br/>(共享数据库)
            MainProcess->>TelegramAPI: notify_user_payment_success()
            TelegramAPI->>User: ✅ 支付成功通知<br/>订单信息<br/>🔄 正在生成报告
            
            MainProcess->>MainProcess: process_paid_order()<br/>(order_processor)
            
            Note over MainProcess: 在main.py进程中执行订单处理流程
            
            MainProcess->>MainProcess: [步骤2] 调用缘分居API（如果需要）<br/>(bazi_service)
            MainProcess->>YuanfenjuAPI: HTTP请求
            YuanfenjuAPI-->>MainProcess: 返回八字数据
            MainProcess->>MainProcess: [步骤3] 调用DeepSeek API<br/>(ai_service)
            MainProcess->>DeepSeekAPI: HTTP请求
            DeepSeekAPI-->>MainProcess: 返回AI报告
            MainProcess->>TelegramAPI: [步骤4] 发送报告给用户
            TelegramAPI->>User: 发送报告
            MainProcess->>MainProcess: 更新订单状态为 "completed"<br/>(共享数据库)
            
            WebhookServer-->>PingPong: 返回 200 OK
        else 订单状态为 "failed"
            WebhookServer->>WebhookServer: 更新订单状态为 "failed"<br/>(共享数据库)
            WebhookServer-->>PingPong: 返回 200 OK
            
            Note over MainProcess: main.py定时任务检测到失败订单
            
            MainProcess->>MainProcess: 定时任务检查订单状态
            MainProcess->>MainProcess: 发现状态为 "failed" 的订单
            MainProcess->>TelegramAPI: 通知用户支付失败
            TelegramAPI->>User: 发送失败通知
        end
    end
```

---

## 三、订单状态流转图

```mermaid
stateDiagram-v2
    [*] --> pending_payment: 用户确认订单
    
    pending_payment --> paid: PingPong Webhook<br/>(status: "paid")
    pending_payment --> failed: PingPong Webhook<br/>(status: "failed")
    
    paid --> generating: 开始处理订单
    
    generating --> completed: 报告生成成功<br/>并发送给用户
    generating --> failed: API调用失败<br/>或超时（自动退款）
    
    completed --> [*]
    failed --> [*]
    
    note right of pending_payment
        订单创建
        等待支付
    end note
    
    note right of paid
        支付成功
        等待处理
    end note
    
    note right of generating
        正在生成报告
        调用外部API
    end note
    
    note right of completed
        报告已发送
        订单完成
    end note
    
    note right of failed
        订单失败
        可能已退款
    end note
```

---

## 四、关键时间点说明

### 4.1 用户下单阶段（同步）

- **时间**: 用户操作时间（几秒）
- **操作**: 选择产品 → 输入信息 → 确认订单
- **结果**: 订单创建，状态为 `pending_payment`
- **进程**: main.py（进程1）

### 4.2 用户支付阶段（用户操作）

- **时间**: 用户支付时间（几分钟）
- **操作**: 跳转PingPong → 完成支付
- **结果**: PingPong处理支付

### 4.3 PingPong通知阶段（异步）

- **时间**: 支付完成后立即（几秒）
- **操作**: PingPong发送Webhook → 验证签名 → 更新订单
- **结果**: 订单状态更新为 `paid`
- **进程**: Webhook服务器（进程2）

### 4.4 业务逻辑处理阶段（异步）

- **时间**: 几分钟（取决于API响应时间）
- **操作**: 
  - 调用缘分居API（如果需要，约5-10秒）
  - 调用DeepSeek API（约30-120秒，可能重试）
  - 发送报告给用户（几秒）
- **结果**: 订单状态更新为 `completed`
- **进程**: Webhook服务器（进程2）

---

## 五、关键配置

### 5.1 PingPong Webhook URL

```
开发环境（ngrok）:
https://xxxx-xx-xx-xx-xx.ngrok-free.app/webhook/pingpong

生产环境:
https://yourdomain.com/webhook/pingpong
```

### 5.2 支付链接中的notify_url

在创建支付链接时，`notify_url` 参数设置为：

```python
notify_url = f"{settings.WEBHOOK_URL}/webhook/pingpong"
```

这告诉PingPong在支付状态变更时，向这个URL发送Webhook通知。

---

## 六、错误处理流程

```mermaid
sequenceDiagram
    participant PingPong as PingPong支付系统 #FFB4B4
    participant WebhookServer as 进程2: Webhook服务器<br/>(webhooks/server.py) #B4E5FF
    participant TelegramAPI as Telegram Bot API #B4E5FF
    participant User as 用户 #FFE5B4
    participant YuanfenjuAPI as 缘分居API #FFB4E5
    participant DeepSeekAPI as DeepSeek API #E5B4FF

    PingPong->>WebhookServer: Webhook通知 (status: "paid")
    WebhookServer->>WebhookServer: 验证签名并更新订单状态为 "paid"<br/>(共享数据库)
    WebhookServer-->>PingPong: 返回 200 OK
    
    Note over MainProcess: main.py定时任务检测到已支付订单
    
    MainProcess->>MainProcess: 定时任务检查订单状态
    MainProcess->>MainProcess: 发现状态为 "paid" 的订单
    MainProcess->>MainProcess: 开始处理订单 (order_processor)
    
    alt 缘分居API调用失败（如果需要）
        MainProcess->>YuanfenjuAPI: 调用缘分居API
        YuanfenjuAPI-->>MainProcess: API调用失败
        MainProcess->>MainProcess: 记录错误
        MainProcess->>MainProcess: 如果是付费产品，触发退款<br/>(共享数据库)
        MainProcess->>TelegramAPI: 通知用户失败原因
        TelegramAPI->>User: 发送失败通知
        MainProcess->>MainProcess: 更新订单状态为 "failed"<br/>(共享数据库)
    else DeepSeek API调用失败
        MainProcess->>DeepSeekAPI: 调用DeepSeek API
        DeepSeekAPI-->>MainProcess: API调用失败
        MainProcess->>MainProcess: 重试（最多3次，指数退避）
        alt 所有重试都失败
            MainProcess->>MainProcess: 记录错误
            MainProcess->>MainProcess: 如果是付费产品，触发退款<br/>(共享数据库)
            MainProcess->>TelegramAPI: 通知用户失败原因
            TelegramAPI->>User: 发送失败通知
            MainProcess->>MainProcess: 更新订单状态为 "failed"<br/>(共享数据库)
        end
    else 报告发送失败
        MainProcess->>MainProcess: 记录错误
        MainProcess->>TelegramAPI: 重试发送报告
        TelegramAPI->>User: 发送报告
        MainProcess->>MainProcess: 更新订单状态为 "completed"<br/>(共享数据库)
    end
```

---

## 七、进程关系说明

### 7.1 两个独立进程

1. **进程1: main.py** - Telegram Bot主进程
   - 处理用户消息和命令
   - 生成支付链接
   - **处理所有业务逻辑**（调用缘分居API、DeepSeek API等）
   - **定时检查已支付订单并处理**（后台任务）
   - 运行模式：Polling（开发）或Webhook（生产）

2. **进程2: webhooks/server.py** - PingPong Webhook服务器
   - **仅作为PingPong支付结果的消息转发通道**
   - 接收PingPong支付回调
   - 验证签名
   - 更新订单状态为 "paid"（共享数据库）
   - **不处理业务逻辑**（不调用缘分居API、DeepSeek API等）

### 7.2 进程间通信

- **共享数据库**: 两个进程访问同一个数据库
  - Webhook服务器：更新订单状态为 "paid"
  - main.py：定时检查状态为 "paid" 的订单并处理
- **定时任务**: main.py中的后台任务定期检查已支付订单
- **共享代码**: 两个进程使用相同的业务逻辑代码（services），但业务逻辑只在main.py中执行

### 7.3 部署要求

- ✅ 两个进程都需要运行
- ✅ Webhook服务器需要HTTPS（PingPong要求）
- ✅ 可以部署在同一服务器或不同服务器
- ✅ main.py需要运行定时任务，定期检查并处理已支付订单

---

**提示**: 这些时序图可以在支持Mermaid的Markdown查看器中直接渲染（如GitHub、GitLab、VS Code等）。

**相关文档**: 
- [项目架构与进程关系说明](./项目架构与进程关系说明.md) - 详细的架构说明
- [支付流程与Webhook机制详解](./支付流程与Webhook机制详解.md) - 详细的流程说明
