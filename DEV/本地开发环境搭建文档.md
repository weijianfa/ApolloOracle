# 本地开发环境搭建文档

本文档将指导您完成"阿波罗神谕"Telegram机器人的本地开发环境搭建。

---

## 一、系统要求

### 1.1 操作系统
- **Windows**: Windows 10/11 或更高版本
- **macOS**: macOS 10.15 或更高版本
- **Linux**: Ubuntu 20.04+ / CentOS 7+ / 其他主流Linux发行版

### 1.2 硬件要求
- **CPU**: 2核心或以上
- **内存**: 4GB RAM 或以上（推荐8GB）
- **硬盘**: 至少1GB可用空间
- **网络**: 稳定的互联网连接（用于API调用）

### 1.3 软件要求
- **Python**: 3.9 或更高版本（推荐 3.10 或 3.11）
- **Git**: 用于版本控制
- **代码编辑器**: VS Code / PyCharm / 其他IDE（可选）

---

## 二、Python环境安装

### 2.1 检查Python版本

打开终端（Windows: PowerShell/CMD, macOS/Linux: Terminal），运行：

```bash
python --version
```

或

```bash
python3 --version
```

如果版本低于 3.9，请先安装Python 3.9+。

### 2.2 安装Python

#### Windows
1. 访问 [Python官网](https://www.python.org/downloads/)
2. 下载最新版本的Python 3.9+
3. 运行安装程序，**务必勾选 "Add Python to PATH"**
4. 完成安装后，重启终端验证

#### macOS
```bash
# 使用Homebrew安装（推荐）
brew install python@3.11

# 或下载官方安装包
# https://www.python.org/downloads/macos/
```

#### Linux (Ubuntu/Debian)
```bash
sudo apt update
sudo apt install python3.9 python3.9-venv python3-pip
```

#### Linux (CentOS/RHEL)
```bash
sudo yum install python39 python39-pip
```

### 2.3 验证安装

```bash
python --version
# 或
python3 --version

pip --version
# 或
pip3 --version
```

---

## 三、项目初始化

### 3.1 克隆或创建项目目录

如果您已有项目仓库：

```bash
git clone <repository-url>
cd telegram-bot
```

如果没有，创建项目目录：

```bash
mkdir telegram-bot
cd telegram-bot
```

### 3.2 创建Python虚拟环境

**强烈推荐使用虚拟环境**，避免依赖冲突。

#### Windows
```powershell
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
.\venv\Scripts\Activate.ps1

# 如果遇到执行策略错误，运行：
# Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

#### macOS/Linux
```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate
```

激活成功后，终端提示符前会显示 `(venv)`。

### 3.3 升级pip

```bash
pip install --upgrade pip
```

---

## 四、安装项目依赖

### 4.1 创建requirements.txt

在项目根目录创建 `requirements.txt` 文件，内容如下：

```txt
# Telegram Bot框架
python-telegram-bot==20.7

# 环境变量管理
python-dotenv==1.0.0

# HTTP请求
requests==2.31.0

# 数据库ORM
sqlalchemy==2.0.23

# 数据库迁移
alembic==1.12.1

# Redis客户端（可选，开发环境可不用）
redis==5.0.1

# 国际化
python-babel==2.13.1

# GeoIP数据库（用于地理限制）
maxminddb==2.2.0

# 测试框架
pytest==7.4.3
pytest-cov==4.1.0

# 其他工具
python-dateutil==2.8.2
```

### 4.2 安装依赖

```bash
pip install -r requirements.txt
```

如果安装过程中遇到问题，可以尝试：

```bash
# 使用国内镜像源（中国用户）
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

---

## 五、环境变量配置

### 5.1 创建.env文件

在项目根目录创建 `.env` 文件（注意：不要提交到Git仓库）。

### 5.2 创建.env.example模板

创建 `.env.example` 文件作为模板：

```bash
# Telegram Bot配置
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here

# PingPong Payment配置
PINGPONG_API_KEY=your_pingpong_api_key_here
PINGPONG_WEBHOOK_SECRET=your_webhook_secret_here
PINGPONG_MERCHANT_ID=your_merchant_id_here
PINGPONG_API_BASE_URL=https://api.pingpongx.com
# 设置为true即可使用Mock模式（开发环境推荐）
PINGPONG_USE_MOCK=true
PINGPONG_MOCK_PAYMENT_URL=https://example.com/mock-pingpong-payment

# DeepSeek API配置
DEEPSEEK_API_KEY=your_deepseek_api_key_here
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions

# 缘分居API配置
YUANFENJU_API_KEY=your_yuanfenju_api_key_here
YUANFENJU_API_URL=https://api.yuanfenju.com/v1/bazi

# 汇率API配置
# 注意：exchangerate-api.com 免费版不需要API密钥，可以直接使用
# 如果使用付费版，可以填写API密钥
EXCHANGE_RATE_API_KEY=
EXCHANGE_RATE_API_URL=https://api.exchangerate-api.com/v4/latest/USD

# 数据库配置（开发环境使用SQLite）
DATABASE_URL=sqlite:///bot.db

# Redis配置（可选，开发环境可不用）
REDIS_URL=redis://localhost:6379/0

# 管理员配置
ADMIN_TELEGRAM_ID=your_telegram_user_id_here
ADMIN_EMAIL=admin@example.com

# 环境标识
ENVIRONMENT=development

# 日志级别
LOG_LEVEL=INFO

# MaxMind GeoIP配置（可选）
MAXMIND_LICENSE_KEY=your_maxmind_license_key_here
```

### 5.3 复制模板并填写

```bash
# Windows
copy .env.example .env

# macOS/Linux
cp .env.example .env
```

然后使用文本编辑器打开 `.env` 文件，填入实际的API密钥。

---

## 六、获取API密钥

### 6.1 Telegram Bot Token

1. 打开Telegram，搜索 `@BotFather`
2. 发送 `/newbot` 命令
3. 按照提示设置Bot名称和用户名
4. BotFather会返回Bot Token，格式类似：`123456789:ABCdefGHIjklMNOpqrsTUVwxyz`
5. 将Token复制到 `.env` 文件的 `TELEGRAM_BOT_TOKEN`

**注意**: 
- 不要将Token分享给他人
- 如果Token泄露，立即在BotFather中撤销并重新生成

### 6.2 PingPong Payment API密钥

1. 注册PingPong账户
2. 登录PingPong商户后台
3. 在"API管理"或"开发者设置"中获取：
   - API Key
   - Webhook Secret
   - Merchant ID
4. 填入 `.env` 文件对应字段
5. **开发/测试环境** 可将 `PINGPONG_USE_MOCK=true`，此时无需真实API调用，系统会使用Mock数据模拟支付流程

### 6.3 DeepSeek API密钥

1. 访问 [DeepSeek官网](https://www.deepseek.com/)
2. 注册/登录账户
3. 进入API管理页面
4. 创建API Key
5. 将Key复制到 `.env` 文件的 `DEEPSEEK_API_KEY`

### 6.4 缘分居API密钥

1. 联系项目负责人获取缘分居API密钥
2. 将Key填入 `.env` 文件的 `YUANFENJU_API_KEY`

### 6.5 汇率API配置

**好消息**：exchangerate-api.com 的免费版**不需要API密钥**！

根据 [exchangerate-api.com 官方文档](https://www.exchangerate-api.com/docs/free)，免费版可以直接访问 `https://api.exchangerate-api.com/v4/latest/USD` 获取实时汇率，无需注册或API密钥。

**配置方法**：
1. 在 `.env` 文件中，`EXCHANGE_RATE_API_KEY` 可以留空（或填写空字符串）
2. `EXCHANGE_RATE_API_URL` 使用默认值：`https://api.exchangerate-api.com/v4/latest/USD`
3. 系统会自动调用免费API获取实时汇率

**注意事项**：
- 免费版有请求频率限制（通常足够使用）
- 如果需要更高频率或更多功能，可以注册付费版并填写API密钥
- 参考文档：https://www.exchangerate-api.com/docs/free

### 6.6 管理员Telegram ID

1. 在Telegram中搜索 `@userinfobot`
2. 发送任意消息给该Bot
3. 它会返回您的Telegram User ID（数字）
4. 将ID填入 `.env` 文件的 `ADMIN_TELEGRAM_ID`

---

## 七、数据库初始化

### 7.1 创建数据库目录

```bash
mkdir -p database
```

### 7.2 初始化数据库（使用Alembic）

```bash
# 初始化Alembic
alembic init alembic

# 创建迁移文件
alembic revision --autogenerate -m "Initial migration"

# 执行迁移
alembic upgrade head
```

### 7.3 手动创建SQLite数据库（简单方式）

如果使用SQLite，可以直接创建数据库文件：

```bash
# 在项目根目录会自动创建 bot.db 文件
# 首次运行程序时会自动创建表结构
```

---

## 八、Redis配置（可选）

### 8.1 安装Redis

#### Windows
1. 下载Redis for Windows: https://github.com/microsoftarchive/redis/releases
2. 解压并运行 `redis-server.exe`
3. 或使用WSL安装Redis

#### macOS
```bash
brew install redis
brew services start redis
```

#### Linux (Ubuntu/Debian)
```bash
sudo apt install redis-server
sudo systemctl start redis
sudo systemctl enable redis
```

### 8.2 验证Redis运行

```bash
redis-cli ping
# 应该返回: PONG
```

**注意**: 开发环境可以暂时不使用Redis，汇率缓存可以存储在内存或数据库中。

---

## 九、项目目录结构

创建完整的项目目录结构：

```bash
# Windows PowerShell
New-Item -ItemType Directory -Force -Path bot\handlers, bot\services, bot\models, bot\database, bot\utils, bot\config, webhooks, prompts, locales, tests

# macOS/Linux
mkdir -p bot/handlers bot/services bot/models bot/database bot/utils bot/config webhooks prompts locales tests
```

### 9.1 创建必要的初始化文件

```bash
# 创建 __init__.py 文件
# Windows
New-Item -ItemType File -Path bot\__init__.py, bot\handlers\__init__.py, bot\services\__init__.py, bot\models\__init__.py, bot\utils\__init__.py, bot\config\__init__.py

# macOS/Linux
touch bot/__init__.py bot/handlers/__init__.py bot/services/__init__.py bot/models/__init__.py bot/utils/__init__.py bot/config/__init__.py
```

---

## 十、创建基础配置文件

### 10.1 创建config/settings.py

```python
import os
from dotenv import load_dotenv

load_dotenv()

class Settings:
    # Telegram Bot
    TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
    
    # PingPong Payment
    PINGPONG_API_KEY = os.getenv("PINGPONG_API_KEY")
    PINGPONG_WEBHOOK_SECRET = os.getenv("PINGPONG_WEBHOOK_SECRET")
    PINGPONG_MERCHANT_ID = os.getenv("PINGPONG_MERCHANT_ID")
    
    # DeepSeek API
    DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY")
    DEEPSEEK_API_URL = os.getenv("DEEPSEEK_API_URL", "https://api.deepseek.com/v1/chat/completions")
    
    # 缘分居API
    YUANFENJU_API_KEY = os.getenv("YUANFENJU_API_KEY")
    YUANFENJU_API_URL = os.getenv("YUANFENJU_API_URL", "https://api.yuanfenju.com/v1/bazi")
    
    # 汇率API
    EXCHANGE_RATE_API_KEY = os.getenv("EXCHANGE_RATE_API_KEY")
    EXCHANGE_RATE_API_URL = os.getenv("EXCHANGE_RATE_API_URL", "https://api.exchangerate-api.com/v4/latest/USD")
    
    # 数据库
    DATABASE_URL = os.getenv("DATABASE_URL", "sqlite:///bot.db")
    
    # Redis
    REDIS_URL = os.getenv("REDIS_URL", "redis://localhost:6379/0")
    
    # 管理员
    ADMIN_TELEGRAM_ID = int(os.getenv("ADMIN_TELEGRAM_ID", "0"))
    ADMIN_EMAIL = os.getenv("ADMIN_EMAIL", "")
    
    # 环境
    ENVIRONMENT = os.getenv("ENVIRONMENT", "development")
    LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO")
    
    @classmethod
    def validate(cls):
        """验证必要的配置项"""
        required = [
            "TELEGRAM_BOT_TOKEN",
            "PINGPONG_API_KEY",
            "DEEPSEEK_API_KEY",
        ]
        missing = [key for key in required if not getattr(cls, key)]
        if missing:
            raise ValueError(f"Missing required environment variables: {', '.join(missing)}")

settings = Settings()
```

### 10.2 创建main.py（基础版本）

```python
import logging
from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes
from bot.config.settings import settings

# 配置日志
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=getattr(logging, settings.LOG_LEVEL)
)
logger = logging.getLogger(__name__)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """处理 /start 命令"""
    await update.message.reply_text(
        "欢迎使用阿波罗神谕Bot！\n"
        "Welcome to Apollo Oracle Bot!\n\n"
        "使用 /help 查看帮助\n"
        "Use /help for help"
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """处理 /help 命令"""
    await update.message.reply_text(
        "可用命令：\n"
        "Available commands:\n\n"
        "/start - 开始\n"
        "/help - 帮助"
    )

def main():
    """主函数"""
    # 验证配置
    try:
        settings.validate()
    except ValueError as e:
        logger.error(f"Configuration error: {e}")
        return
    
    # 创建应用
    application = Application.builder().token(settings.TELEGRAM_BOT_TOKEN).build()
    
    # 注册命令处理器
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    
    # 启动Bot
    logger.info("Bot starting...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()
```

---

## 十一、运行项目

### 11.1 测试运行

```bash
python main.py
```

如果一切正常，您应该看到：
```
2024-11-14 10:00:00 - __main__ - INFO - Bot starting...
```

### 11.2 测试Bot

1. 在Telegram中搜索您的Bot（使用BotFather创建时设置的用户名）
2. 发送 `/start` 命令
3. Bot应该回复欢迎消息

### 11.3 停止Bot

在终端中按 `Ctrl + C` 停止Bot。

---

## 十二、开发工具推荐

### 12.1 代码编辑器

- **VS Code**: 免费，插件丰富
  - 推荐插件：Python, Pylance, GitLens
- **PyCharm**: JetBrains出品，功能强大（有社区版）

### 12.2 数据库管理工具

- **DB Browser for SQLite**: SQLite数据库可视化工具
- **DBeaver**: 支持多种数据库
- **pgAdmin**: PostgreSQL管理工具（生产环境）

### 12.3 API测试工具

- **Postman**: API测试和调试
- **curl**: 命令行HTTP客户端

### 12.4 版本控制

- **Git**: 版本控制系统
- **GitHub Desktop**: Git图形界面（可选）

---

## 十三、常见问题排查

### 13.1 Python版本问题

**问题**: `python: command not found`

**解决方案**:
- Windows: 确保安装时勾选了"Add Python to PATH"
- macOS/Linux: 使用 `python3` 命令

### 13.2 虚拟环境激活失败

**问题**: Windows PowerShell提示"无法加载文件"

**解决方案**:
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### 13.3 依赖安装失败

**问题**: `pip install` 失败，网络超时

**解决方案**:
```bash
# 使用国内镜像源
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 或增加超时时间
pip install --default-timeout=100 -r requirements.txt
```

### 13.4 Telegram Bot无响应

**问题**: Bot创建成功但无响应

**检查清单**:
1. ✅ 确认Bot Token正确（无多余空格）
2. ✅ 确认网络连接正常
3. ✅ 确认Bot已启动（查看日志）
4. ✅ 确认已发送 `/start` 命令给Bot

### 13.5 数据库连接失败

**问题**: SQLite数据库文件无法创建

**解决方案**:
- 检查目录权限
- 确认数据库路径正确
- 手动创建数据库目录

### 13.6 API调用失败

**问题**: API返回401/403错误

**检查清单**:
1. ✅ 确认API Key正确
2. ✅ 确认API Key未过期
3. ✅ 确认API Key有相应权限
4. ✅ 检查API调用频率限制

---

## 十四、下一步

环境搭建完成后，您可以：

1. **阅读开发计划文档**: 了解项目整体架构和开发阶段
2. **开始MVP开发**: 按照开发计划文档的阶段一进行开发
3. **编写单元测试**: 为关键功能编写测试用例
4. **配置Git仓库**: 初始化Git并设置.gitignore

### 14.1 .gitignore文件

创建 `.gitignore` 文件，避免提交敏感信息：

```gitignore
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
venv/
env/
ENV/

# 环境变量
.env
.env.local

# 数据库
*.db
*.sqlite
*.sqlite3

# IDE
.vscode/
.idea/
*.swp
*.swo

# 日志
*.log
logs/

# 系统文件
.DS_Store
Thumbs.db

# 测试
.pytest_cache/
.coverage
htmlcov/
```

---

## 十五、开发环境验证清单

完成以下检查，确保环境配置正确：

- [ ] Python 3.9+ 已安装
- [ ] 虚拟环境已创建并激活
- [ ] 所有依赖包已安装
- [ ] `.env` 文件已创建并配置
- [ ] Telegram Bot Token已获取并配置
- [ ] 所有API密钥已获取并配置
- [ ] 数据库已初始化
- [ ] 项目目录结构已创建
- [ ] `main.py` 可以正常运行
- [ ] Bot可以响应 `/start` 命令
- [ ] 日志输出正常

---

## 十六、获取帮助

如果遇到问题：

1. **查看日志**: 检查控制台输出的错误信息
2. **查阅文档**: 参考开发计划文档和API文档
3. **搜索问题**: 在Stack Overflow、GitHub Issues中搜索类似问题
4. **联系团队**: 向项目负责人或开发团队寻求帮助

---

**文档版本**: v1.0  
**最后更新**: 2024-11-14  
**维护者**: 开发团队

