# 第一阶段测试指南

本文档指导如何测试第一阶段（MVP核心功能）的开发成果。

## 一、环境准备

### 1.1 检查环境

运行环境检查脚本：

```bash
python scripts/check_environment.py
```

确保所有检查项都通过。

### 1.2 安装依赖

如果依赖未安装，运行：

```bash
pip install -r requirements.txt
```

### 1.3 配置环境变量

1. 复制环境变量模板：
   ```bash
   copy .env.example .env
   ```

2. 编辑 `.env` 文件，至少配置：
   ```
   TELEGRAM_BOT_TOKEN=your_bot_token_here
   ENVIRONMENT=development
   ```

3. 获取Bot Token：
   - 在Telegram中搜索 `@BotFather`
   - 发送 `/newbot` 创建新Bot
   - 复制返回的Token到 `.env` 文件

## 二、运行基础功能测试

### 2.1 运行测试脚本

```bash
python scripts/test_bot.py
```

测试脚本会验证：
- ✅ 数据库初始化
- ✅ 产品配置
- ✅ 输入验证
- ✅ 消息分段
- ✅ 数据库操作
- ✅ 配置验证

### 2.2 运行单元测试（可选）

如果安装了pytest：

```bash
pytest tests/ -v
```

## 三、启动Bot进行实际测试

### 3.1 启动Bot

```bash
python main.py
```

如果配置正确，应该看到：
```
2024-11-14 10:00:00 - bot - INFO - Configuration validated successfully
2024-11-14 10:00:00 - bot - INFO - Database initialized successfully
2024-11-14 10:00:00 - bot - INFO - Bot starting...
2024-11-14 10:00:00 - bot - INFO - Environment: development
2024-11-14 10:00:00 - bot - INFO - Using Polling mode (development)
```

### 3.2 测试Bot功能

在Telegram中：

1. **测试 /start 命令**
   - 搜索您的Bot
   - 发送 `/start`
   - 应该看到产品菜单（6个产品按钮）

2. **测试产品选择**
   - 点击任意产品按钮
   - 应该看到产品信息和输入提示

3. **测试输入流程（以"每日塔罗"为例）**
   - 选择"每日塔罗"（产品1，无需输入）
   - 应该直接进入确认页面
   - 点击"确认并支付"（会提示需要配置支付API）

4. **测试输入验证（以"每周星座"为例）**
   - 选择"每周星座"（产品2）
   - 应该提示选择星座
   - 选择星座后进入确认页面

5. **测试取消功能**
   - 在任何步骤发送 `/cancel`
   - 应该取消当前操作

6. **测试帮助功能**
   - 发送 `/help`
   - 应该显示帮助信息

## 四、测试检查清单

### 4.1 基础功能
- [ ] Bot可以正常启动
- [ ] `/start` 命令显示产品菜单
- [ ] 产品按钮可以点击
- [ ] 产品信息正确显示
- [ ] 输入流程正常工作
- [ ] 输入验证正常工作
- [ ] `/cancel` 命令可以取消操作
- [ ] `/help` 命令显示帮助

### 4.2 数据库功能
- [ ] 数据库文件已创建（bot.db）
- [ ] 用户信息正确保存
- [ ] 会话状态正确保存
- [ ] 订单信息正确保存

### 4.3 产品功能
- [ ] 6种产品都能正常选择
- [ ] 不同产品的输入流程正确
- [ ] 产品价格正确显示

## 五、已知限制

### 5.1 需要配置的功能
以下功能需要实际API密钥才能测试：
- ⚠️ 支付功能（需要PingPong API密钥）
- ⚠️ 八字API调用（需要缘分居API密钥）
- ⚠️ AI报告生成（需要DeepSeek API密钥）

### 5.2 待完善的功能
- ⚠️ 支付确认流程（需要支付API配置）
- ⚠️ 报告发送（需要AI API配置）
- ⚠️ 操作日志记录（需要在代码中集成）

## 六、问题排查

### 6.1 Bot无法启动

**问题**: `Configuration error: Missing required environment variables`

**解决**: 检查 `.env` 文件，确保 `TELEGRAM_BOT_TOKEN` 已配置

### 6.2 数据库错误

**问题**: `Failed to initialize database`

**解决**: 
- 检查数据库文件权限
- 确保目录可写
- 检查数据库URL配置

### 6.3 导入错误

**问题**: `ModuleNotFoundError`

**解决**: 运行 `pip install -r requirements.txt` 安装依赖

### 6.4 Bot无响应

**问题**: Bot启动但无响应

**解决**:
- 检查Bot Token是否正确
- 检查网络连接
- 查看日志输出

## 七、测试报告模板

测试完成后，请填写：

```
测试日期: ___________
测试人员: ___________

基础功能测试:
- Bot启动: [ ] 通过 [ ] 失败
- /start命令: [ ] 通过 [ ] 失败
- 产品选择: [ ] 通过 [ ] 失败
- 输入流程: [ ] 通过 [ ] 失败
- 输入验证: [ ] 通过 [ ] 失败

数据库测试:
- 数据库初始化: [ ] 通过 [ ] 失败
- 数据保存: [ ] 通过 [ ] 失败

发现的问题:
1. 
2. 
3. 

备注:
```

---

**测试完成后，请将测试结果反馈给开发团队。**

