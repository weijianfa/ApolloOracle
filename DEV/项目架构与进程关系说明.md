# 项目架构与进程关系说明

**文档版本**: v1.0  
**最后更新**: 2025-11-18

---

## 一、项目进程结构

### 1.1 进程划分

项目包含**两个独立的进程**：

#### 进程1：Telegram Bot主进程（main.py）

**启动方式**:
```bash
python main.py
```

**功能**:
- 接收和处理Telegram用户消息
- 处理用户命令（/start, /help, /cancel等）
- 处理产品选择和输入流程
- 生成支付链接并发送给用户
- 运行模式：
  - 开发环境：Polling模式（主动拉取消息）
  - 生产环境：Webhook模式（接收Telegram推送的消息）

**端口**: 
- 开发环境：无（Polling模式）
- 生产环境：`WEBHOOK_PORT`（默认8443，用于接收Telegram Webhook）

---

#### 进程2：PingPong Webhook服务器（webhooks/server.py）

**启动方式**:
```bash
python webhooks/server.py
# 或
python scripts/start_webhook_server.py
```

**功能**:
- **仅作为PingPong支付结果的消息转发通道**
- 接收PingPong支付系统的Webhook回调
- 验证支付签名（HMAC）
- 更新订单状态为 "paid"（共享数据库）
- **不处理业务逻辑**（不调用缘分居API、DeepSeek API等）
- **不发送消息给用户**（由main.py进程负责）

**⚠️ 重要**: Webhook服务器应该只负责接收和验证支付通知，业务逻辑应该在main.py进程中处理。

**端口**: `PINGPONG_WEBHOOK_PORT`（默认8000）

**路由**:
- `POST /webhook/pingpong` - 接收PingPong支付回调
- `GET /health` - 健康检查

---

### 1.2 进程间通信

两个进程**不直接通信**，而是通过以下方式协作：

1. **共享数据库**
   - 两个进程都访问同一个数据库（SQLite或PostgreSQL）
   - **Webhook服务器**: 更新订单状态为 "paid"
   - **main.py**: 定时检查状态为 "paid" 的订单并处理

2. **定时任务（main.py）**
   - main.py运行后台定时任务，定期检查已支付订单
   - 发现状态为 "paid" 的订单后，触发业务逻辑处理
   - 处理完成后更新订单状态为 "completed"

3. **业务逻辑层共享**
   - 两个进程都使用相同的业务逻辑模块（services）
   - **但业务逻辑只在main.py进程中执行**
   - Webhook服务器不调用业务逻辑代码

---

## 二、完整系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                     用户（Telegram客户端）                    │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ Telegram协议
                        │
        ┌───────────────┴───────────────┐
        │                               │
        ▼                               ▼
┌───────────────┐              ┌──────────────────┐
│ Telegram Bot  │              │ Telegram Bot API  │
│    API        │              │  (官方服务器)      │
└───────┬───────┘              └────────┬─────────┘
        │                               │
        │                               │
        ▼                               │
┌───────────────────────────────────────┴──────────────┐
│           进程1: main.py (Telegram Bot主进程)         │
│  ┌──────────────────────────────────────────────┐  │
│  │  handlers/                                     │  │
│  │    - start.py (处理/start命令)                 │  │
│  │    - product.py (产品选择和输入)                │  │
│  │    - payment.py (生成支付链接)                  │  │
│  │    - affiliate.py (推广员功能)                 │  │
│  │    - admin.py (管理员命令)                      │  │
│  └──────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────┐  │
│  │  services/ (业务逻辑层)                        │  │
│  │    - payment_service.py                        │  │
│  │    - order_processor.py                        │  │
│  │    - bazi_service.py                           │  │
│  │    - ai_service.py                             │  │
│  │    - affiliate_service.py                      │  │
│  └──────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────┐  │
│  │  database/ (数据库访问)                        │  │
│  │    - db.py                                    │  │
│  └──────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
                        │
                        │ 共享数据库
                        │
┌───────────────────────┴──────────────────────────────┐
│           进程2: webhooks/server.py                    │
│              (PingPong Webhook服务器)                  │
│  ┌──────────────────────────────────────────────┐  │
│  │  webhooks/                                     │  │
│  │    - pingpong.py (接收PingPong回调)            │  │
│  │    - server.py (FastAPI服务器)                 │  │
│  └──────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────┐  │
│  │  services/ (业务逻辑层 - 共享代码)               │  │
│  │    - payment_service.py                        │  │
│  │    - order_processor.py                        │  │
│  │    - bazi_service.py                           │  │
│  │    - ai_service.py                             │  │
│  └──────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────┐  │
│  │  database/ (数据库访问 - 共享数据库)            │  │
│  │    - db.py                                    │  │
│  └──────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────┐  │
│  │  Telegram Bot API (直接调用)                   │  │
│  │    - 发送支付成功通知                          │  │
│  │    - 发送报告给用户                            │  │
│  └──────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
                        │
                        │ HTTPS
                        │
        ┌───────────────┴───────────────┐
        │                               │
        ▼                               ▼
┌───────────────┐              ┌──────────────────┐
│ PingPong      │              │ 外部API服务        │
│ 支付系统       │              │  - 缘分居API       │
│               │              │  - DeepSeek API    │
└───────────────┘              └──────────────────┘
```

---

## 三、关键设计决策

### 3.1 为什么Webhook服务器是独立进程？

**原因**:
1. **端口分离**: 
   - Telegram Bot Webhook需要特定端口（生产环境）
   - PingPong Webhook需要不同端口（8000）
   - 两个服务可以独立部署和扩展

2. **职责分离**:
   - main.py专注于处理用户交互
   - Webhook服务器专注于处理支付回调

3. **部署灵活性**:
   - 可以分别部署在不同的服务器
   - 可以独立扩展和监控

### 3.2 Webhook服务器是否应该发送消息给用户？

**答案**: **不应该**

**正确的架构**:
- Webhook服务器只负责验证签名和更新订单状态
- main.py进程通过定时任务检查已支付订单
- main.py进程负责发送消息给用户和处理业务逻辑

**当前代码实现的问题**:
- `webhooks/pingpong.py` 中的 `notify_user_payment_success()` 和 `trigger_order_processing()` 不应该存在
- 这些功能应该在main.py的定时任务中实现

**建议的修改**:
1. 移除 `webhooks/pingpong.py` 中的 `notify_user_payment_success()` 和 `trigger_order_processing()`
2. 在main.py中添加定时任务，定期检查状态为 "paid" 的订单
3. 在main.py的定时任务中处理订单和发送消息

---

## 四、数据流说明

### 4.1 用户下单流程

```
用户 → Telegram Bot API → main.py进程
  → handlers/product.py
  → payment_service.create_order()
  → 数据库（创建订单）
  → payment_service.create_payment_link()
  → PingPong API（创建支付）
  → 返回支付链接
  → 用户
```

### 4.2 支付成功流程

```
PingPong → Webhook服务器（进程2）
  → webhooks/pingpong.py
  → payment_service.process_payment_webhook()
  → 数据库（更新订单状态为paid）
  → 返回200 OK给PingPong

（Webhook服务器完成，不处理业务逻辑）

main.py定时任务（进程1）
  → 检查数据库中的订单状态
  → 发现状态为 "paid" 的订单
  → 更新订单状态为 "generating"
  → notify_user_payment_success()
  → Telegram Bot API
  → 用户（收到支付成功通知）
  → order_processor.process_paid_order()
  → bazi_service.get_bazi_data()
  → 缘分居API（外部调用）
  → ai_service.generate_report()
  → DeepSeek API（外部调用）
  → order_processor._send_report_to_user()
  → Telegram Bot API
  → 用户（收到报告）
  → 数据库（更新订单状态为completed）
```

---

## 五、部署建议

### 5.1 开发环境

**运行两个进程**:

```bash
# 终端1: 运行Telegram Bot
python main.py

# 终端2: 运行Webhook服务器
python webhooks/server.py

# 终端3: 运行ngrok（如果需要）
ngrok http 8000
```

### 5.2 生产环境

**选项1：同一服务器，不同进程**
- 使用systemd或supervisor管理两个进程
- 使用Nginx反向代理处理SSL和路由

**选项2：不同服务器**
- main.py部署在服务器A
- Webhook服务器部署在服务器B
- 共享数据库（PostgreSQL）

---

## 六、注意事项

### 6.1 数据库连接

- 两个进程都连接同一个数据库
- 需要确保数据库连接池配置合理
- SQLite在并发写入时可能有问题，生产环境建议使用PostgreSQL

### 6.2 Bot Token共享

- 两个进程使用相同的Bot Token
- 确保`.env`文件中的`TELEGRAM_BOT_TOKEN`一致

### 6.3 日志管理

- 两个进程的日志应该分开管理
- 建议使用统一的日志系统（如ELK Stack）

---

## 七、总结

### 7.1 进程关系

- ✅ **main.py** 和 **webhooks/server.py** 是**两个独立的进程**
- ✅ 它们通过**共享数据库**和**共享业务逻辑代码**协作
- ✅ Webhook服务器**直接调用Telegram Bot API**发送消息，不通过main.py

### 7.2 通信方式

- ✅ 数据库：共享订单状态、用户信息
- ✅ Telegram Bot API：Webhook服务器直接调用发送消息
- ✅ 业务逻辑层：共享代码库，但运行在不同进程

### 7.3 部署要求

- ✅ 两个进程都需要运行
- ✅ Webhook服务器需要HTTPS（PingPong要求）
- ✅ 两个进程可以部署在同一服务器或不同服务器

---

**重要提示**: 时序图需要反映这两个独立进程的关系，Webhook服务器是独立的FastAPI进程，不是main.py的一部分。

